<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê±°ë˜ì²˜ ìë™ì™„ì„± í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-box {
            border: 2px solid #4CAF50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        #result {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 500px;
            overflow-y: auto;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ğŸ” ê±°ë˜ì²˜ ìë™ì™„ì„± API í…ŒìŠ¤íŠ¸</h1>

    <div class="test-box">
        <h3>Step 1: ë¡œê·¸ì¸ ì •ë³´ í™•ì¸</h3>
        <p>í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì: <strong id="currentUser">í™•ì¸ ì¤‘...</strong></p>
        <button onclick="checkLoginStatus()">ğŸ”„ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸</button>
    </div>

    <div class="test-box">
        <h3>Step 2: ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸</h3>
        <p>ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë‹´ë‹¹ ê±°ë˜ì²˜ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
        <button onclick="testGetCompanies()">ğŸ“‹ ë‹´ë‹¹ ê±°ë˜ì²˜ ì¡°íšŒ</button>
    </div>

    <div class="test-box">
        <h3>Step 3: ìë™ì™„ì„± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h3>
        <input type="text" id="searchInput" placeholder="ê±°ë˜ì²˜ëª… ì…ë ¥..." style="width: 300px; padding: 10px; font-size: 16px;">
        <div id="autocompleteResult" style="margin-top: 10px; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; display: none;">
            <!-- ìë™ì™„ì„± ê²°ê³¼ -->
        </div>
    </div>

    <div id="result">
        <p class="info">ğŸ” ìœ„ì˜ ë²„íŠ¼ë“¤ì„ í´ë¦­í•˜ì—¬ APIë¥¼ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.</p>
    </div>

    <script type="module">
        import Storage from './05.Source/01.common/15_storage_manager.js';
        import ApiManager from './05.Source/01.common/13_api_manager.js';

        const storage = new Storage();
        const apiManager = new ApiManager();

        // API Manager ì´ˆê¸°í™”
        await apiManager.init();

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.storage = storage;
        window.apiManager = apiManager;
        window.companies = [];

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        window.checkLoginStatus = function() {
            const currentUser = storage.get('currentUser');
            const resultDiv = document.getElementById('result');

            if (currentUser) {
                document.getElementById('currentUser').textContent = `${currentUser.name} (${currentUser.department})`;
                resultDiv.innerHTML = `
                    <p class="success">âœ… ë¡œê·¸ì¸ ì •ë³´ í™•ì¸ ì„±ê³µ</p>
                    <pre>${JSON.stringify(currentUser, null, 2)}</pre>
                `;
            } else {
                document.getElementById('currentUser').textContent = 'ë¡œê·¸ì¸ ì•ˆ ë¨';
                resultDiv.innerHTML = `
                    <p class="error">âŒ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p>ë¨¼ì € ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                `;
            }
        };

        // ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ
        window.testGetCompanies = async function() {
            const resultDiv = document.getElementById('result');
            const currentUser = storage.get('currentUser');

            if (!currentUser) {
                resultDiv.innerHTML = '<p class="error">âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="info">ğŸ”„ ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì¤‘...</p>';

            try {
                console.log('[Test] API í˜¸ì¶œ ì‹œì‘:', currentUser.name);

                const response = await apiManager.getCompaniesByManager(currentUser.name);

                console.log('[Test] API ì‘ë‹µ:', response);

                if (response.success) {
                    window.companies = response.companies || [];

                    resultDiv.innerHTML = `
                        <p class="success">âœ… ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì„±ê³µ!</p>
                        <p><strong>ì´ ${response.count}ê°œì˜ ê±°ë˜ì²˜</strong></p>
                        <hr>
                        <h4>ê±°ë˜ì²˜ ëª©ë¡:</h4>
                        <pre>${JSON.stringify(response.companies, null, 2)}</pre>
                    `;

                    // ìë™ì™„ì„± í™œì„±í™”
                    enableAutocomplete();
                } else {
                    resultDiv.innerHTML = `
                        <p class="error">âŒ API ì‘ë‹µ ì˜¤ë¥˜</p>
                        <pre>${JSON.stringify(response, null, 2)}</pre>
                    `;
                }

            } catch (error) {
                console.error('[Test] API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                resultDiv.innerHTML = `
                    <p class="error">âŒ API í˜¸ì¶œ ì‹¤íŒ¨</p>
                    <p>ì—ëŸ¬: ${error.message}</p>
                    <pre>${error.stack}</pre>
                `;
            }
        };

        // ìë™ì™„ì„± í™œì„±í™”
        function enableAutocomplete() {
            const searchInput = document.getElementById('searchInput');
            const autocompleteResult = document.getElementById('autocompleteResult');

            searchInput.addEventListener('input', function(e) {
                const inputValue = e.target.value.trim().toLowerCase();

                if (!inputValue) {
                    autocompleteResult.style.display = 'none';
                    return;
                }

                // í•„í„°ë§
                const filtered = window.companies.filter(company => {
                    const companyName = (company.finalCompanyName || company.companyName || '').toLowerCase();
                    return companyName.includes(inputValue);
                });

                // ê²°ê³¼ í‘œì‹œ
                if (filtered.length > 0) {
                    autocompleteResult.innerHTML = filtered.slice(0, 10).map(company => {
                        const companyName = company.finalCompanyName || company.companyName;
                        return `<div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;"
                                     onmouseover="this.style.background='#f0f0f0'"
                                     onmouseout="this.style.background='white'"
                                     onclick="selectCompany('${companyName}')">
                                    ${companyName}
                                </div>`;
                    }).join('');
                    autocompleteResult.style.display = 'block';
                } else {
                    autocompleteResult.innerHTML = '<div style="padding: 10px; color: #999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    autocompleteResult.style.display = 'block';
                }
            });
        }

        window.selectCompany = function(companyName) {
            document.getElementById('searchInput').value = companyName;
            document.getElementById('autocompleteResult').style.display = 'none';
            document.getElementById('result').innerHTML = `
                <p class="success">âœ… ê±°ë˜ì²˜ ì„ íƒ: <strong>${companyName}</strong></p>
            `;
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        checkLoginStatus();
    </script>
</body>
</html>
