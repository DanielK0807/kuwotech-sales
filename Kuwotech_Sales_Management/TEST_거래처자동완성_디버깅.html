<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>거래처 자동완성 디버깅</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-box {
            background: white;
            border: 2px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #2196F3;
            margin-top: 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0b7dda;
        }
    </style>
</head>
<body>
    <h1>🔍 실적보고서 작성 - 거래처 자동완성 디버깅</h1>

    <div class="debug-box">
        <h2>📋 체크리스트</h2>
        <div id="checklist">
            <p>⏳ 진단 중...</p>
        </div>
    </div>

    <div class="debug-box">
        <h2>🔄 수동 테스트</h2>
        <button onclick="runDiagnostics()">진단 실행</button>
        <button onclick="testAPI()">API 직접 호출</button>
        <button onclick="checkElements()">DOM 요소 확인</button>
    </div>

    <div class="debug-box">
        <h2>📊 결과</h2>
        <div id="result">
            <p class="status info">위의 "진단 실행" 버튼을 클릭하세요.</p>
        </div>
    </div>

    <script type="module">
        import Storage from './05.Source/01.common/15_storage_manager.js';
        import ApiManager from './05.Source/01.common/13_api_manager.js';

        const storage = new Storage();
        const apiManager = new ApiManager();
        await apiManager.init();

        window.storage = storage;
        window.apiManager = apiManager;

        // 자동 진단
        async function autoDiagnose() {
            const checklist = document.getElementById('checklist');
            let html = '';
            let issues = [];

            // 1. 로그인 확인
            const currentUser = storage.get('currentUser');
            if (currentUser) {
                html += `<p class="status success">✅ 로그인 상태: ${currentUser.name}</p>`;
            } else {
                html += `<p class="status error">❌ 로그인 안 됨</p>`;
                issues.push('로그인 필요');
            }

            // 2. API Manager 확인
            if (apiManager) {
                html += `<p class="status success">✅ API Manager 로드 완료</p>`;
                html += `<p class="status info">📍 서버 주소: ${apiManager.config.baseURL}</p>`;
            } else {
                html += `<p class="status error">❌ API Manager 로드 실패</p>`;
                issues.push('API Manager 없음');
            }

            // 3. 서버 연결 확인
            try {
                const healthCheck = await apiManager.checkServerConnection(true);
                if (healthCheck) {
                    html += `<p class="status success">✅ 백엔드 서버 연결 정상</p>`;
                } else {
                    html += `<p class="status error">❌ 백엔드 서버 연결 실패</p>`;
                    issues.push('서버 연결 안 됨');
                }
            } catch (error) {
                html += `<p class="status error">❌ 서버 연결 에러: ${error.message}</p>`;
                issues.push('서버 연결 에러');
            }

            checklist.innerHTML = html;

            if (issues.length > 0) {
                checklist.innerHTML += `<p class="status error"><strong>문제 발견:</strong> ${issues.join(', ')}</p>`;
            } else {
                checklist.innerHTML += `<p class="status success"><strong>✅ 모든 체크 통과!</strong></p>`;
            }
        }

        // 진단 실행
        window.runDiagnostics = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="status info">🔄 진단 중...</p>';

            const currentUser = storage.get('currentUser');
            if (!currentUser) {
                resultDiv.innerHTML = '<p class="status error">❌ 로그인이 필요합니다. 먼저 로그인 페이지에서 로그인하세요.</p>';
                return;
            }

            try {
                // API 호출
                console.log('[디버깅] API 호출 시작:', currentUser.name);
                const response = await apiManager.getCompaniesByManager(currentUser.name);
                console.log('[디버깅] API 응답:', response);

                if (response.success) {
                    const companies = response.companies || [];

                    resultDiv.innerHTML = `
                        <p class="status success">✅ API 호출 성공!</p>
                        <p><strong>담당 거래처 개수: ${companies.length}개</strong></p>
                        <hr>
                        <h3>거래처 목록:</h3>
                        <pre>${JSON.stringify(companies, null, 2)}</pre>
                        <hr>
                        <h3>💡 해결 방법</h3>
                        <p>위에 거래처가 정상적으로 표시되면 <strong>실적보고서 작성 페이지의 JavaScript가 제대로 작동하지 않는 것</strong>입니다.</p>
                        <p>브라우저에서 실적보고서 작성 페이지를 열고 <strong>F12 → Console 탭</strong>을 확인하세요.</p>
                        <p>다음과 같은 로그가 있어야 합니다:</p>
                        <pre>[Report Write] 거래처 목록 로드 중...
[Report Write] 담당자: ${currentUser.name}
[Report Write] 거래처 목록 로드 성공: X개</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <p class="status error">❌ API 응답 실패</p>
                        <p>메시지: ${response.message || '알 수 없는 오류'}</p>
                        <pre>${JSON.stringify(response, null, 2)}</pre>
                    `;
                }

            } catch (error) {
                console.error('[디버깅] 에러:', error);
                resultDiv.innerHTML = `
                    <p class="status error">❌ API 호출 실패</p>
                    <p><strong>에러:</strong> ${error.message}</p>
                    <pre>${error.stack}</pre>
                `;
            }
        };

        // API 직접 호출
        window.testAPI = async function() {
            const resultDiv = document.getElementById('result');
            const currentUser = storage.get('currentUser');

            if (!currentUser) {
                resultDiv.innerHTML = '<p class="status error">❌ 로그인 필요</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="status info">🔄 API 직접 호출 중...</p>';

            try {
                const url = `${apiManager.config.baseURL}/companies/manager/${encodeURIComponent(currentUser.name)}`;
                console.log('[직접 호출] URL:', url);

                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('[직접 호출] 응답:', data);

                resultDiv.innerHTML = `
                    <p class="status success">✅ API 직접 호출 성공</p>
                    <p><strong>URL:</strong> ${url}</p>
                    <p><strong>상태 코드:</strong> ${response.status}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="status error">❌ 직접 호출 실패</p>
                    <p>${error.message}</p>
                `;
            }
        };

        // DOM 요소 확인
        window.checkElements = function() {
            const resultDiv = document.getElementById('result');

            // 실적보고서 작성 페이지를 새 탭에서 열고 콘솔 확인하도록 안내
            resultDiv.innerHTML = `
                <p class="status info">📋 DOM 요소 확인 방법</p>
                <ol>
                    <li><strong>실적보고서 작성 페이지</strong>를 브라우저에서 엽니다.</li>
                    <li><strong>F12</strong>를 눌러 개발자 도구를 엽니다.</li>
                    <li><strong>Console 탭</strong>으로 이동합니다.</li>
                    <li>아래 코드를 복사해서 콘솔에 붙여넣고 Enter를 누르세요:</li>
                </ol>
                <pre>// 거래처 입력란 확인
console.log('companySelect:', document.getElementById('companySelect'));
console.log('companyAutocompleteList:', document.getElementById('companyAutocompleteList'));

// 이벤트 리스너 확인
const companyInput = document.getElementById('companySelect');
console.log('이벤트 리스너:', getEventListeners(companyInput));

// state.companies 확인 (만약 존재한다면)
if (typeof state !== 'undefined') {
    console.log('state.companies:', state.companies);
}</pre>
                <hr>
                <h3>예상 결과:</h3>
                <p>✅ <code>companySelect</code>와 <code>companyAutocompleteList</code>가 정상적으로 표시되어야 함</p>
                <p>✅ <code>input</code> 또는 <code>focus</code> 이벤트 리스너가 있어야 함</p>
                <p>✅ <code>state.companies</code>에 거래처 배열이 있어야 함</p>
            `;
        };

        // 페이지 로드 시 자동 진단
        autoDiagnose();
    </script>
</body>
</html>
