<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê±°ë˜ì²˜ ìë™ì™„ì„± ë””ë²„ê¹…</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-box {
            background: white;
            border: 2px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #2196F3;
            margin-top: 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0b7dda;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ì‹¤ì ë³´ê³ ì„œ ì‘ì„± - ê±°ë˜ì²˜ ìë™ì™„ì„± ë””ë²„ê¹…</h1>

    <div class="debug-box">
        <h2>ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
        <div id="checklist">
            <p>â³ ì§„ë‹¨ ì¤‘...</p>
        </div>
    </div>

    <div class="debug-box">
        <h2>ğŸ”„ ìˆ˜ë™ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="runDiagnostics()">ì§„ë‹¨ ì‹¤í–‰</button>
        <button onclick="testAPI()">API ì§ì ‘ í˜¸ì¶œ</button>
        <button onclick="checkElements()">DOM ìš”ì†Œ í™•ì¸</button>
    </div>

    <div class="debug-box">
        <h2>ğŸ“Š ê²°ê³¼</h2>
        <div id="result">
            <p class="status info">ìœ„ì˜ "ì§„ë‹¨ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
        </div>
    </div>

    <script type="module">
        import Storage from './05.Source/01.common/15_storage_manager.js';
        import ApiManager from './05.Source/01.common/13_api_manager.js';

        const storage = new Storage();
        const apiManager = new ApiManager();
        await apiManager.init();

        window.storage = storage;
        window.apiManager = apiManager;

        // ìë™ ì§„ë‹¨
        async function autoDiagnose() {
            const checklist = document.getElementById('checklist');
            let html = '';
            let issues = [];

            // 1. ë¡œê·¸ì¸ í™•ì¸
            const currentUser = storage.get('currentUser');
            if (currentUser) {
                html += `<p class="status success">âœ… ë¡œê·¸ì¸ ìƒíƒœ: ${currentUser.name}</p>`;
            } else {
                html += `<p class="status error">âŒ ë¡œê·¸ì¸ ì•ˆ ë¨</p>`;
                issues.push('ë¡œê·¸ì¸ í•„ìš”');
            }

            // 2. API Manager í™•ì¸
            if (apiManager) {
                html += `<p class="status success">âœ… API Manager ë¡œë“œ ì™„ë£Œ</p>`;
                html += `<p class="status info">ğŸ“ ì„œë²„ ì£¼ì†Œ: ${apiManager.config.baseURL}</p>`;
            } else {
                html += `<p class="status error">âŒ API Manager ë¡œë“œ ì‹¤íŒ¨</p>`;
                issues.push('API Manager ì—†ìŒ');
            }

            // 3. ì„œë²„ ì—°ê²° í™•ì¸
            try {
                const healthCheck = await apiManager.checkServerConnection(true);
                if (healthCheck) {
                    html += `<p class="status success">âœ… ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì •ìƒ</p>`;
                } else {
                    html += `<p class="status error">âŒ ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</p>`;
                    issues.push('ì„œë²„ ì—°ê²° ì•ˆ ë¨');
                }
            } catch (error) {
                html += `<p class="status error">âŒ ì„œë²„ ì—°ê²° ì—ëŸ¬: ${error.message}</p>`;
                issues.push('ì„œë²„ ì—°ê²° ì—ëŸ¬');
            }

            checklist.innerHTML = html;

            if (issues.length > 0) {
                checklist.innerHTML += `<p class="status error"><strong>ë¬¸ì œ ë°œê²¬:</strong> ${issues.join(', ')}</p>`;
            } else {
                checklist.innerHTML += `<p class="status success"><strong>âœ… ëª¨ë“  ì²´í¬ í†µê³¼!</strong></p>`;
            }
        }

        // ì§„ë‹¨ ì‹¤í–‰
        window.runDiagnostics = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="status info">ğŸ”„ ì§„ë‹¨ ì¤‘...</p>';

            const currentUser = storage.get('currentUser');
            if (!currentUser) {
                resultDiv.innerHTML = '<p class="status error">âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>';
                return;
            }

            try {
                // API í˜¸ì¶œ
                console.log('[ë””ë²„ê¹…] API í˜¸ì¶œ ì‹œì‘:', currentUser.name);
                const response = await apiManager.getCompaniesByManager(currentUser.name);
                console.log('[ë””ë²„ê¹…] API ì‘ë‹µ:', response);

                if (response.success) {
                    const companies = response.companies || [];

                    resultDiv.innerHTML = `
                        <p class="status success">âœ… API í˜¸ì¶œ ì„±ê³µ!</p>
                        <p><strong>ë‹´ë‹¹ ê±°ë˜ì²˜ ê°œìˆ˜: ${companies.length}ê°œ</strong></p>
                        <hr>
                        <h3>ê±°ë˜ì²˜ ëª©ë¡:</h3>
                        <pre>${JSON.stringify(companies, null, 2)}</pre>
                        <hr>
                        <h3>ğŸ’¡ í•´ê²° ë°©ë²•</h3>
                        <p>ìœ„ì— ê±°ë˜ì²˜ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ë©´ <strong>ì‹¤ì ë³´ê³ ì„œ ì‘ì„± í˜ì´ì§€ì˜ JavaScriptê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠëŠ” ê²ƒ</strong>ì…ë‹ˆë‹¤.</p>
                        <p>ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤ì ë³´ê³ ì„œ ì‘ì„± í˜ì´ì§€ë¥¼ ì—´ê³  <strong>F12 â†’ Console íƒ­</strong>ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                        <p>ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:</p>
                        <pre>[Report Write] ê±°ë˜ì²˜ ëª©ë¡ ë¡œë“œ ì¤‘...
[Report Write] ë‹´ë‹¹ì: ${currentUser.name}
[Report Write] ê±°ë˜ì²˜ ëª©ë¡ ë¡œë“œ ì„±ê³µ: Xê°œ</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <p class="status error">âŒ API ì‘ë‹µ ì‹¤íŒ¨</p>
                        <p>ë©”ì‹œì§€: ${response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
                        <pre>${JSON.stringify(response, null, 2)}</pre>
                    `;
                }

            } catch (error) {
                console.error('[ë””ë²„ê¹…] ì—ëŸ¬:', error);
                resultDiv.innerHTML = `
                    <p class="status error">âŒ API í˜¸ì¶œ ì‹¤íŒ¨</p>
                    <p><strong>ì—ëŸ¬:</strong> ${error.message}</p>
                    <pre>${error.stack}</pre>
                `;
            }
        };

        // API ì§ì ‘ í˜¸ì¶œ
        window.testAPI = async function() {
            const resultDiv = document.getElementById('result');
            const currentUser = storage.get('currentUser');

            if (!currentUser) {
                resultDiv.innerHTML = '<p class="status error">âŒ ë¡œê·¸ì¸ í•„ìš”</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="status info">ğŸ”„ API ì§ì ‘ í˜¸ì¶œ ì¤‘...</p>';

            try {
                const url = `${apiManager.config.baseURL}/companies/manager/${encodeURIComponent(currentUser.name)}`;
                console.log('[ì§ì ‘ í˜¸ì¶œ] URL:', url);

                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('[ì§ì ‘ í˜¸ì¶œ] ì‘ë‹µ:', data);

                resultDiv.innerHTML = `
                    <p class="status success">âœ… API ì§ì ‘ í˜¸ì¶œ ì„±ê³µ</p>
                    <p><strong>URL:</strong> ${url}</p>
                    <p><strong>ìƒíƒœ ì½”ë“œ:</strong> ${response.status}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="status error">âŒ ì§ì ‘ í˜¸ì¶œ ì‹¤íŒ¨</p>
                    <p>${error.message}</p>
                `;
            }
        };

        // DOM ìš”ì†Œ í™•ì¸
        window.checkElements = function() {
            const resultDiv = document.getElementById('result');

            // ì‹¤ì ë³´ê³ ì„œ ì‘ì„± í˜ì´ì§€ë¥¼ ìƒˆ íƒ­ì—ì„œ ì—´ê³  ì½˜ì†” í™•ì¸í•˜ë„ë¡ ì•ˆë‚´
            resultDiv.innerHTML = `
                <p class="status info">ğŸ“‹ DOM ìš”ì†Œ í™•ì¸ ë°©ë²•</p>
                <ol>
                    <li><strong>ì‹¤ì ë³´ê³ ì„œ ì‘ì„± í˜ì´ì§€</strong>ë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ ì—½ë‹ˆë‹¤.</li>
                    <li><strong>F12</strong>ë¥¼ ëˆŒëŸ¬ ê°œë°œì ë„êµ¬ë¥¼ ì—½ë‹ˆë‹¤.</li>
                    <li><strong>Console íƒ­</strong>ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</li>
                    <li>ì•„ë˜ ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ì½˜ì†”ì— ë¶™ì—¬ë„£ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”:</li>
                </ol>
                <pre>// ê±°ë˜ì²˜ ì…ë ¥ë€ í™•ì¸
console.log('companySelect:', document.getElementById('companySelect'));
console.log('companyAutocompleteList:', document.getElementById('companyAutocompleteList'));

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í™•ì¸
const companyInput = document.getElementById('companySelect');
console.log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ:', getEventListeners(companyInput));

// state.companies í™•ì¸ (ë§Œì•½ ì¡´ì¬í•œë‹¤ë©´)
if (typeof state !== 'undefined') {
    console.log('state.companies:', state.companies);
}</pre>
                <hr>
                <h3>ì˜ˆìƒ ê²°ê³¼:</h3>
                <p>âœ… <code>companySelect</code>ì™€ <code>companyAutocompleteList</code>ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ì–´ì•¼ í•¨</p>
                <p>âœ… <code>input</code> ë˜ëŠ” <code>focus</code> ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ìˆì–´ì•¼ í•¨</p>
                <p>âœ… <code>state.companies</code>ì— ê±°ë˜ì²˜ ë°°ì—´ì´ ìˆì–´ì•¼ í•¨</p>
            `;
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì§„ë‹¨
        autoDiagnose();
    </script>
</body>
</html>
