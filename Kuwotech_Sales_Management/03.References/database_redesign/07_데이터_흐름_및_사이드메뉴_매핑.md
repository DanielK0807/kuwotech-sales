# 데이터 흐름 및 사이드메뉴 매핑

## 영업담당 모드 (6개 메뉴)

### 1. 실적보고서 작성

| 메뉴명 | 사이드메뉴 위치 | 작업 테이블 | 작업 유형 | 입력 필드 | 자동 생성 필드 | 트리거 |
|--------|---------------|-----------|---------|----------|--------------|--------|
| 실적보고서 작성 | 영업담당 > 실적보고서 작성 | reports | INSERT, UPDATE | submittedDate, companyId, reportType, targetCollectionAmount, targetSalesAmount, targetProducts, activityNotes, status | reportId (UUID), submittedBy (로그인 사용자), createdAt, updatedAt | companies 테이블 자동업데이트 (판매제품, 마지막결제일, 마지막총결제금액, 누적수금/매출, 영업활동(특이사항)) |

**데이터 흐름**:
1. 거래처 선택 (자신의 담당 거래처만) → companyId 입력
2. 기본 정보 입력 (submittedDate, reportType)
3. 목표 설정 (targetCollectionAmount, targetSalesAmount, targetProducts)
4. 활동 기록 (activityNotes)
5. 임시저장 (status='임시저장') 또는 제출 (status='제출완료')
6. 트리거 발동: 승인 시 companies 테이블의 6개 필드 자동업데이트
7. change_history 테이블에 변경이력 기록

---

### 2. 내 보고서 목록

| 메뉴명 | 사이드메뉴 위치 | 조회 테이블 | 조회 조건 | 표시 필드 | 작업 |
|--------|---------------|-----------|---------|----------|------|
| 내 보고서 목록 | 영업담당 > 내 보고서 목록 | reports | submittedBy = 로그인 사용자명 | reportId, companyId (거래처명 표시), submittedDate, reportType, targetSalesAmount, targetCollectionAmount, status, processedDate | 조회, 수정 (임시저장/반려 상태만), 삭제 (임시저장 상태만) |

**데이터 흐름**:
1. reports 테이블에서 submittedBy = 로그인 사용자 조건으로 조회
2. companies 테이블과 JOIN하여 거래처명 표시
3. status별 필터링 (전체, 임시저장, 제출완료, 승인, 반려)
4. 클릭 시 상세보기 → 수정/삭제 가능 (권한에 따라)

---

### 3. 담당거래처 관리

| 메뉴명 | 사이드메뉴 위치 | 조회 테이블 | 조회 조건 | 표시 필드 | 수정 가능 필드 | 읽기 전용 필드 |
|--------|---------------|-----------|---------|----------|---------------|--------------|
| 담당거래처 관리 | 영업담당 > 담당거래처 관리 | companies | salesPerson = 로그인 사용자명 | keyValue, finalCompanyName, industry, businessType, salesPerson, phone, contactPerson, contactPhone, status, 판매제품, 누적매출, 누적수금 | phone, fax, email, contactPerson, contactPhone | companyNameERP, finalCompanyName, industry, businessType, salesPerson, address, status, 판매제품, 마지막결제일, 누적수금, 누적매출, 영업활동 |

**데이터 흐름**:
1. companies 테이블에서 salesPerson = 로그인 사용자 조건으로 조회
2. 영업담당은 연락처 정보만 수정 가능 (phone, fax, email, contactPerson, contactPhone)
3. 나머지 필드는 읽기 전용 (관리자만 수정 가능)
4. 수정 시 change_history 테이블에 변경이력 기록

---

### 4. 내 실적 현황 (KPI)

| 메뉴명 | 사이드메뉴 위치 | 데이터 소스 | 계산 방식 | 표시 KPI |
|--------|---------------|-----------|---------|---------|
| 내 실적 현황 | 영업담당 > 내 실적 현황 | reports (submittedBy = 로그인 사용자, status='승인') | 실시간 집계 | 방문 횟수 (오늘/주/월/전체), 매출 금액 (오늘/주/월/전체), 수금 금액 (오늘/주/월/전체), 담당 거래처 수, 활성 거래처 수 |

**데이터 흐름**:
1. reports 테이블에서 submittedBy = 로그인 사용자, status='승인' 조건으로 집계
2. visitDate 기준으로 오늘/이번주/이번달 필터링
3. SUM(salesAmount), SUM(collectionAmount), COUNT(*) 계산
4. companies 테이블에서 담당 거래처 수 조회
5. reports에서 최근 30일 방문한 거래처 수 조회 (활성 거래처)

---

### 5. 내 변경이력

| 메뉴명 | 사이드메뉴 위치 | 조회 테이블 | 조회 조건 | 표시 필드 |
|--------|---------------|-----------|---------|----------|
| 내 변경이력 | 영업담당 > 내 변경이력 | change_history | changedBy = 로그인 사용자명 | changedAt, tableName, operation, recordId, oldData (변경전), newData (변경후) |

**데이터 흐름**:
1. change_history 테이블에서 changedBy = 로그인 사용자 조건으로 조회
2. 날짜 내림차순 정렬 (최신순)
3. tableName별 필터링 (companies, reports)
4. oldData, newData를 JSON 파싱하여 변경내용 표시

---

### 6. 내 정보

| 메뉴명 | 사이드메뉴 위치 | 조회 테이블 | 조회 조건 | 표시 필드 | 수정 가능 필드 |
|--------|---------------|-----------|---------|----------|---------------|
| 내 정보 | 영업담당 > 내 정보 | employees | name = 로그인 사용자명 | name, email, department, hireDate, phone, lastLogin | phone, password (비밀번호 변경) |

**데이터 흐름**:
1. employees 테이블에서 name = 로그인 사용자 조건으로 조회
2. 전화번호 수정 가능
3. 비밀번호 변경 시 bcrypt 해싱 후 업데이트
4. 수정 시 change_history 테이블에 변경이력 기록 (password 제외)

---

## 관리자 모드 (7개 메뉴)

### 1. 담당거래처 관리

| 메뉴명 | 사이드메뉴 위치 | 작업 테이블 | 작업 유형 | 입력 필드 (전체) | 자동 생성 필드 | 읽기 전용 필드 (자동계산) |
|--------|---------------|-----------|---------|---------------|--------------|---------------------|
| 담당거래처 관리 | 관리자 > 담당거래처 관리 | companies | INSERT, UPDATE, DELETE | companyNameERP, finalCompanyName, industry, businessType, businessItem, salesPerson, address, phone, fax, email, contactPerson, contactPhone, status | keyValue (UUID), createdAt, updatedAt | 판매제품, 마지막결제일, 누적수금, 누적매출, 영업활동 |

**데이터 흐름**:
1. 전체 거래처 조회 (companies 테이블)
2. 신규 거래처 등록: ERP 연동 또는 수동 입력
3. 기본 정보 수정 (companyNameERP, finalCompanyName, industry, businessType, businessItem, salesPerson, address, phone, fax, email, contactPerson, contactPhone, status)
4. 자동계산 필드는 읽기 전용 (판매제품, 마지막결제일, 누적수금, 누적매출, 영업활동)
5. 수정/삭제 시 change_history 테이블에 변경이력 기록

---

### 2. 보고서 승인

| 메뉴명 | 사이드메뉴 위치 | 조회 테이블 | 조회 조건 | 표시 필드 | 작업 |
|--------|---------------|-----------|---------|----------|------|
| 보고서 승인 | 관리자 > 보고서 승인 | reports | status='제출완료' 또는 전체 | reportId, submittedBy, companyName, visitDate, activityType, salesAmount, collectionAmount, status, submittedAt | 승인 (status='승인', approvedAt/approvedBy 자동기록), 반려 (status='반려', rejectionReason 입력) |

**데이터 흐름**:
1. reports 테이블에서 전체 보고서 조회 (status 필터링 가능)
2. 제출완료 상태 보고서 선택
3. 승인: status='승인', approvedAt=NOW(), approvedBy=로그인 관리자명
4. 반려: status='반려', rejectionReason 입력
5. 승인/반려 시 change_history 테이블에 변경이력 기록

---

### 3. 직원 관리

| 메뉴명 | 사이드메뉴 위치 | 작업 테이블 | 작업 유형 | 입력 필드 | 자동 생성 필드 |
|--------|---------------|-----------|---------|----------|--------------|
| 직원 관리 | 관리자 > 직원 관리 | employees | INSERT, UPDATE, DELETE | name, email, password, role, department, hireDate, phone, status | id (AUTO_INCREMENT), createdAt, updatedAt, lastLogin |

**데이터 흐름**:
1. 전체 직원 조회 (employees 테이블)
2. 신규 직원 등록: name, email, password (초기), role, department, hireDate, phone 입력
3. password는 bcrypt 해싱 후 저장
4. status 변경: 재직/휴직/퇴사
5. 퇴사 시 담당 거래처 재배정 필요 (companies.salesPerson 변경)
6. 수정/삭제 시 change_history 테이블에 변경이력 기록 (password 제외)

---

### 4. 전체 실적 현황 (KPI)

| 메뉴명 | 사이드메뉴 위치 | 데이터 소스 | 계산 방식 | 표시 KPI |
|--------|---------------|-----------|---------|---------|
| 전체 실적 현황 | 관리자 > 전체 실적 현황 | reports (status='승인') | 실시간 집계 | **팀 전체**: 방문 횟수 (오늘/주/월/전체), 매출 금액 (오늘/주/월/전체), 수금 금액 (오늘/주/월/전체), 전체/활성 거래처 수 <br> **직원별**: 이번달 방문/매출/수금 |

**데이터 흐름**:
1. **팀 전체 KPI**: reports 테이블 전체 집계 (status='승인')
   - visitDate 기준 오늘/이번주/이번달 필터링
   - SUM(salesAmount), SUM(collectionAmount), COUNT(*) 계산
2. **거래처 정보**: companies 테이블 전체 수, reports에서 최근 30일 활성 거래처 수
3. **직원별 KPI**: employees 테이블과 reports 테이블 조인
   - 이번달 방문 횟수, 매출, 수금을 직원별로 GROUP BY
   - 매출 내림차순 정렬

---

### 5. 변경이력 조회

| 메뉴명 | 사이드메뉴 위치 | 조회 테이블 | 조회 조건 | 표시 필드 | 필터링 |
|--------|---------------|-----------|---------|----------|--------|
| 변경이력 조회 | 관리자 > 변경이력 조회 | change_history | (전체) | changedAt, changedBy, tableName, operation, recordId, oldData, newData | 날짜, 작업자, 테이블명, 작업유형 |

**데이터 흐름**:
1. change_history 테이블 전체 조회
2. 필터링: 날짜 범위, changedBy (작업자), tableName (테이블), operation (INSERT/UPDATE/DELETE)
3. 날짜 내림차순 정렬 (최신순)
4. oldData, newData JSON 파싱하여 변경내용 상세 표시

---

### 6. 데이터 백업

| 메뉴명 | 사이드메뉴 위치 | 작업 테이블 | 작업 유형 | 백업 대상 | 백업 형식 |
|--------|---------------|-----------|---------|----------|----------|
| 데이터 백업 | 관리자 > 데이터 백업 | backups | INSERT (백업 생성), SELECT (백업 목록), DELETE (백업 삭제) | companies, reports, employees (전체 데이터) | JSON (LONGTEXT) |

**데이터 흐름**:
1. **백업 생성**:
   - companies, reports, employees 테이블 전체 SELECT
   - JSON 구조로 변환 (테이블별 배열)
   - backups 테이블에 INSERT (backupName, backupData, dataSize, recordCount, createdBy)
2. **백업 목록 조회**: backups 테이블 전체 조회
3. **백업 다운로드**: backupData를 JSON 파일로 다운로드
4. **백업 삭제**: 선택한 백업 DELETE

---

### 7. 데이터 복원

| 메뉴명 | 사이드메뉴 위치 | 작업 테이블 | 작업 유형 | 복원 프로세스 |
|--------|---------------|-----------|---------|-------------|
| 데이터 복원 | 관리자 > 데이터 복원 | companies, reports, employees, backups | DELETE (기존 데이터), INSERT (백업 데이터) | 트랜잭션 처리 |

**데이터 흐름**:
1. **복원 전 백업**: 현재 데이터를 자동으로 백업 (시스템 백업)
2. **트랜잭션 시작**: BEGIN TRANSACTION
3. **기존 데이터 삭제**:
   - DELETE FROM reports (FK 먼저)
   - DELETE FROM companies
   - DELETE FROM employees
4. **백업 데이터 복원**:
   - backups 테이블에서 선택한 백업의 backupData 조회
   - JSON 파싱하여 각 테이블에 INSERT
5. **복원 정보 기록**:
   - backups 테이블 UPDATE (isRestored=TRUE, restoredAt, restoredBy)
6. **트랜잭션 커밋**: COMMIT (실패 시 ROLLBACK)

---

## 자동화 프로세스

### 1. 자동 백업 (스케줄러)

| 작업명 | 실행 주기 | 트리거 | 백업 유형 | 보존 기간 |
|--------|---------|--------|----------|----------|
| 자동 백업 | 매일 자정 (00:00) | node-cron | backupType='자동' | 7일 |

**데이터 흐름**:
1. node-cron 스케줄러가 매일 00:00에 자동 실행
2. 전체 데이터 백업 (companies, reports, employees)
3. backups 테이블에 INSERT (backupType='자동')
4. 7일 이상 된 자동 백업 DELETE

---

### 2. companies 테이블 자동 업데이트

| 트리거 테이블 | 트리거 유형 | 업데이트 대상 필드 | 수식 |
|-------------|-----------|---------------|------|
| reports | AFTER INSERT, UPDATE, DELETE | companies.판매제품 | GROUP_CONCAT(DISTINCT productName) |
| reports | AFTER INSERT, UPDATE, DELETE | companies.마지막결제일 | MAX(paymentDate) |
| reports | AFTER INSERT, UPDATE, DELETE | companies.누적수금 | SUM(collectionAmount) |
| reports | AFTER INSERT, UPDATE, DELETE | companies.누적매출 | SUM(salesAmount) |
| reports | AFTER INSERT, UPDATE, DELETE | companies.영업활동 | GROUP_CONCAT(DISTINCT activityType) |

**데이터 흐름**:
1. reports 테이블에 INSERT/UPDATE/DELETE 발생
2. 트리거 자동 실행
3. 해당 companyId의 companies 레코드에서 5개 필드 재계산 및 UPDATE

---

### 3. 변경이력 자동 기록

| 트리거 테이블 | 트리거 유형 | 기록 내용 |
|-------------|-----------|----------|
| companies | AFTER INSERT, UPDATE, DELETE | tableName='companies', operation, recordId=keyValue, oldData, newData |
| reports | AFTER INSERT, UPDATE, DELETE | tableName='reports', operation, recordId=reportId, oldData, newData |
| employees | AFTER UPDATE | tableName='employees', operation, recordId=id, oldData, newData (password 제외) |

**데이터 흐름**:
1. companies/reports/employees 테이블에 INSERT/UPDATE/DELETE 발생
2. 트리거 자동 실행
3. change_history 테이블에 INSERT (changedBy는 세션 변수 @current_user 사용)
4. oldData, newData를 JSON 형식으로 저장

---

## 권한 매트릭스

| 작업 | 테이블 | 영업담당 | 관리자 |
|------|--------|---------|--------|
| 거래처 조회 | companies | ✓ (자신의 담당만) | ✓ (전체) |
| 거래처 등록 | companies | ✗ | ✓ |
| 거래처 수정 (기본정보) | companies | ✗ | ✓ |
| 거래처 수정 (연락처) | companies | ✓ (자신의 담당만) | ✓ |
| 거래처 삭제 | companies | ✗ | ✓ |
| 보고서 작성 | reports | ✓ (자신의 담당 거래처) | ✓ |
| 보고서 조회 | reports | ✓ (자신의 보고서만) | ✓ (전체) |
| 보고서 수정 | reports | ✓ (임시저장/반려 상태) | ✓ (전체) |
| 보고서 삭제 | reports | ✓ (임시저장 상태만) | ✓ (전체) |
| 보고서 승인/반려 | reports | ✗ | ✓ |
| 직원 조회 | employees | ✓ (자신만) | ✓ (전체) |
| 직원 등록 | employees | ✗ | ✓ |
| 직원 수정 (기본정보) | employees | ✗ | ✓ |
| 직원 수정 (자신의 연락처) | employees | ✓ | ✓ |
| 직원 삭제 | employees | ✗ | ✓ |
| KPI 조회 | reports | ✓ (자신만) | ✓ (전체) |
| 변경이력 조회 | change_history | ✓ (자신의 활동만) | ✓ (전체) |
| 백업/복원 | backups | ✗ | ✓ |
