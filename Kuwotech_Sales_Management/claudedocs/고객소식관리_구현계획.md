# 고객소식 관리 시스템 - 구현 계획 및 현황

## 📋 프로젝트 개요

### 목적
거래처 관련 중요 소식(경조사, 생일, 기념일 등)을 체계적으로 관리하고, 전 직원이 공유할 수 있는 시스템 구축

### 주요 기능
1. **고객소식 작성 및 관리** (영업담당)
2. **관리자 의견 제시** (관리자)
3. **로그인 알림 시스템** (전 직원)

---

## ✅ 완료된 작업

### 1. 데이터베이스 설계 ✅
**파일**: `backend/migrations/05_create_customer_news_tables.sql`

#### 생성된 테이블 (3개):

##### 1️⃣ `customer_news` - 고객소식 메인 테이블
```sql
주요 필드:
- id (VARCHAR(36) PK) - UUID
- companyId, companyName - 거래처 정보
- createdBy, department - 작성자 정보
- category (ENUM) - 경조사, 생일, 개업기념일, 일반소식, 중요공지, 기타
- title, content - 제목 및 내용
- newsDate - 소식 발생일
- isYearlyRecurring - 매년 반복 여부
- priority (ENUM) - 낮음, 보통, 높음, 긴급
- showAsNotification - 로그인 시 알림 표시 여부
- notificationStartDate, notificationEndDate - 알림 기간
- status (ENUM) - 활성, 비활성, 삭제됨
- viewCount, commentCount - 통계
```

##### 2️⃣ `customer_news_comments` - 관리자 의견 테이블
```sql
주요 필드:
- id (VARCHAR(36) PK) - UUID
- newsId - 고객소식 ID (FK)
- commentBy, commentByRole - 의견 작성자 정보
- comment - 의견 내용
- commentType (ENUM) - 일반, 질문, 제안, 승인, 반려
- isRead, readAt - 읽음 상태
```

##### 3️⃣ `customer_news_notifications` - 알림 읽음 상태 테이블
```sql
주요 필드:
- id (INT AUTO_INCREMENT PK)
- newsId - 고객소식 ID (FK)
- employeeName - 직원명 (FK)
- viewCount - 조회 횟수 (최대 3회)
- isDismissed - 더이상 보지 않기 여부
- dismissedAt - 해제 시간
- firstViewedAt, lastViewedAt - 조회 이력
```

#### 트리거 (2개):
- `increment_comment_count`: 의견 추가 시 commentCount 증가
- `decrement_comment_count`: 의견 삭제 시 commentCount 감소

---

### 2. 백엔드 API 개발 ✅

#### 라우터 파일
**파일**: `backend/routes/customer-news.routes.js`

#### 컨트롤러 파일
**파일**: `backend/controllers/customer-news.controller.js`

#### API 엔드포인트 목록:

##### 🔹 고객소식 CRUD
| Method | Endpoint | 설명 | 권한 |
|--------|----------|------|------|
| GET | /api/customer-news | 전체 고객소식 조회 (필터링) | 인증 필요 |
| GET | /api/customer-news/:id | 특정 고객소식 조회 | 인증 필요 |
| POST | /api/customer-news | 고객소식 작성 | 인증 필요 |
| PUT | /api/customer-news/:id | 고객소식 수정 | 작성자/관리자 |
| DELETE | /api/customer-news/:id | 고객소식 삭제 | 작성자/관리자 |

##### 🔹 카테고리별 조회
| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | /api/customer-news/category/:category | 카테고리별 조회 |
| GET | /api/customer-news/company/:companyId | 거래처별 조회 |
| GET | /api/customer-news/employee/:employeeName | 작성자별 조회 |

##### 🔹 알림 관련
| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | /api/customer-news/notifications/me | 내 알림 조회 |
| POST | /api/customer-news/notifications/:newsId/view | 알림 조회 카운트 증가 |
| POST | /api/customer-news/notifications/:newsId/dismiss | 더이상 보지 않기 |

##### 🔹 의견 (Comments) 관련
| Method | Endpoint | 설명 | 권한 |
|--------|----------|------|------|
| GET | /api/customer-news/:newsId/comments | 특정 소식의 의견 조회 | 인증 필요 |
| POST | /api/customer-news/:newsId/comments | 의견 작성 | 인증 필요 |
| DELETE | /api/customer-news/comments/:commentId | 의견 삭제 | 작성자/관리자 |
| PUT | /api/customer-news/comments/:commentId/read | 의견 읽음 처리 | 인증 필요 |

##### 🔹 통계 및 기타
| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | /api/customer-news/statistics/overview | 통계 요약 |
| GET | /api/customer-news/events/upcoming | 다가오는 이벤트 (생일, 기념일) |

---

### 3. UI 설계 문서 작성 ✅
**파일**: `claudedocs/고객소식관리_UI설계.md`

#### 설계 내용:
- ✅ 영업담당 모드: 고객소식 조회 화면
- ✅ 영업담당 모드: 고객소식 작성 화면
- ✅ 영업담당 모드: 고객소식 상세보기 + 관리자 의견 확인
- ✅ 관리자 모드: 고객소식 의견제시 화면
- ✅ 로그인 알림 팝업
- ✅ 고객소식 카테고리별 작성 템플릿 (8종)

---

## 🚧 진행 중 / 예정 작업

### 1. 라우터 등록 (app.js) ⏳
**작업 내용**:
```javascript
// backend/app.js에 추가
import customerNewsRoutes from './routes/customer-news.routes.js';

// ... 기존 라우터들 ...
app.use('/api/customer-news', customerNewsRoutes);
```

### 2. 마이그레이션 실행 ⏳
**실행 명령**:
```bash
# Railway MySQL 데이터베이스에 직접 실행
mysql -h [host] -u [user] -p [database] < backend/migrations/05_create_customer_news_tables.sql
```

또는 Railway CLI 사용:
```bash
cd "F:\7.VScode\Running VS Code\KUWOTECH\Kuwotech_Sales_Management"
railway run --service kuwotech-sales-production-aa64 mysql [credentials] < backend/migrations/05_create_customer_news_tables.sql
```

### 3. 프론트엔드 개발 ⏳

#### 📂 예상 파일 구조:
```
frontend/src/
├─ 01_dashboard/
│  └─ 04_customer_news_notification.js  (로그인 알림 팝업)
├─ 08_customer_news/ (신규 디렉토리)
│  ├─ 01_customer_news_list.js         (조회 화면)
│  ├─ 02_customer_news_write.js        (작성 화면)
│  ├─ 03_customer_news_detail.js       (상세보기)
│  └─ 04_admin_comments.js             (관리자 의견)
└─ 00_layouts/
   ├─ 01_sales_layout.js               (메뉴 추가 필요)
   └─ 02_admin_layout.js               (메뉴 추가 필요)
```

#### 📱 개발 우선순위:
1. **최우선**: 로그인 알림 팝업 (핵심 기능)
2. **우선**: 고객소식 조회 및 작성 (영업담당)
3. **우선**: 관리자 의견 제시 (관리자)
4. **선택**: 통계 대시보드

---

## 🎯 고객소식 작성 템플릿 (8종)

### 1. 경조사 - 결혼 🎉
```
카테고리: 경조사
매년 반복: ☑
템플릿: 결혼 예식 정보 (일시, 장소, 홀)
```

### 2. 경조사 - 부고 🙏
```
카테고리: 경조사
매년 반복: ☐
템플릿: 빈소 정보 (위치, 조문 시간, 발인일)
```

### 3. 생일 축하 🎂
```
카테고리: 생일
매년 반복: ☑
템플릿: 생일 정보 (월/일, 선호 브랜드)
```

### 4. 개업/이전 기념일 🏢
```
카테고리: 개업기념일
매년 반복: ☑
템플릿: 개업일, 주소, N주년
```

### 5. 신규 장비/제품 구매 📦
```
카테고리: 일반소식
매년 반복: ☐
템플릿: 제품명, 구매일, 금액, AS 일정
```

### 6. 수상/인증 🏆
```
카테고리: 일반소식
매년 반복: ☐
템플릿: 수상명, 일시, 주관 기관
```

### 7. 확장 이전 🏢
```
카테고리: 일반소식
매년 반복: ☐
템플릿: 이전일, 신규 주소, 규모
```

### 8. 중요 클레임/이슈 ⚠️
```
카테고리: 중요공지
매년 반복: ☐
중요도: 높음/긴급
알림: ☑ (전 직원)
템플릿: 이슈 내용, 조치 사항, 담당자
```

---

## 🔧 기술 스택

### 백엔드
- **Node.js + Express**: REST API
- **MySQL**: 데이터베이스
- **JWT**: 인증/인가
- **uuid**: 고유 ID 생성

### 프론트엔드 (예정)
- **Vanilla JavaScript**: UI 구현
- **CSS**: 스타일링
- **Fetch API**: HTTP 요청

---

## 📊 알림 시스템 동작 방식

### 1. 알림 생성 흐름
```
1. 영업담당자가 고객소식 작성
   ↓
2. "로그인 시 알림 표시" 옵션 활성화 + 알림 기간 설정
   ↓
3. 시스템이 자동으로 모든 재직 중인 직원에게 알림 레코드 생성
   (customer_news_notifications 테이블)
   ↓
4. 각 직원이 로그인 시 알림 조회
```

### 2. 알림 표시 조건
```javascript
조건:
1. showAsNotification = TRUE
2. 현재 날짜가 notificationStartDate ~ notificationEndDate 사이
3. viewCount < 3
4. isDismissed = FALSE
```

### 3. 알림 카운트 증가
```
로그인 시 팝업 표시 → viewCount + 1
최대 3회까지 표시 → 이후 자동으로 표시 안 함
```

### 4. 더이상 보지 않기
```
사용자가 "더이상 보지 않기" 클릭
→ isDismissed = TRUE
→ 이후 로그인 시 표시 안 함
```

---

## 🎨 UI/UX 가이드라인

### 색상 시스템
| 카테고리 | 색상 코드 | 용도 |
|---------|----------|------|
| 경조사 | `#FF6B6B` | 빨강 - 중요 이벤트 |
| 생일 | `#4ECDC4` | 청록 - 축하 이벤트 |
| 개업기념일 | `#FFE66D` | 노랑 - 기념일 |
| 일반소식 | `#95E1D3` | 민트 - 일반 정보 |
| 중요공지 | `#FF8C42` | 주황 - 주의 필요 |
| 긴급 | `#F38181` | 분홍 - 즉시 조치 |

### 아이콘 시스템
- 📌 경조사
- 🎂 생일
- 🏢 개업기념일
- 📰 일반소식
- ⚠️ 중요공지
- 🔔 알림
- 💬 의견

### 반응형 디자인
- **모바일**: 단일 컬럼, 터치 친화적
- **태블릿**: 2단 레이아웃
- **데스크톱**: 3단 레이아웃 (필터 | 목록 | 상세)

---

## 📝 다음 단계 (우선순위 순)

### 1단계: 백엔드 완성 ⚡
```
[  ] app.js에 라우터 등록
[  ] 마이그레이션 실행
[  ] Postman으로 API 테스트
```

### 2단계: 로그인 알림 구현 🔔
```
[  ] 로그인 시 알림 조회 API 호출
[  ] 알림 팝업 컴포넌트 개발
[  ] 더이상 보지 않기 기능 구현
[  ] 조회 카운트 자동 증가
```

### 3단계: 고객소식 조회/작성 (영업담당) 📰
```
[  ] 고객소식 목록 화면
[  ] 필터링 기능 (거래처, 날짜, 카테고리)
[  ] 고객소식 작성 폼
[  ] 거래처 자동완성
[  ] 템플릿 버튼 구현
[  ] 상세보기 화면
```

### 4단계: 관리자 의견 기능 💬
```
[  ] 고객소식 목록 (관리자용)
[  ] 의견 작성 인터페이스
[  ] 의견 읽음 처리
[  ] 영업담당자가 관리자 의견 확인
```

### 5단계: 추가 기능 (선택) ✨
```
[  ] 통계 대시보드
[  ] 캘린더 뷰
[  ] 엑셀 내보내기
[  ] 이메일 알림
[  ] 검색 기능 강화
```

---

## 🧪 테스트 계획

### API 테스트 (Postman)
1. **인증 테스트**: 로그인 → 토큰 발급
2. **고객소식 CRUD**: 작성 → 조회 → 수정 → 삭제
3. **알림 시스템**: 알림 조회 → 조회 카운트 증가 → 해제
4. **의견 시스템**: 의견 작성 → 조회 → 읽음 처리 → 삭제
5. **필터링**: 거래처, 날짜, 카테고리별 조회
6. **통계**: 카테고리별/월별/작성자별 통계

### 프론트엔드 테스트
1. **알림 팝업**: 로그인 시 자동 표시, 3회 제한, 더이상 보지 않기
2. **작성 폼**: 필수 필드 검증, 자동완성, 템플릿 적용
3. **조회 화면**: 필터링, 페이지네이션, 정렬
4. **의견 기능**: 의견 작성, 삭제, 읽음 처리

---

## 💡 개선 아이디어 (향후)

### 단기 (1-2개월)
- [ ] 모바일 앱 연동 (푸시 알림)
- [ ] 이메일 자동 발송 (중요 소식)
- [ ] 캘린더 통합 뷰

### 중기 (3-6개월)
- [ ] AI 기반 소식 카테고리 자동 분류
- [ ] 거래처별 타임라인 뷰
- [ ] 통계 리포트 자동 생성

### 장기 (6개월 이상)
- [ ] CRM 시스템 통합
- [ ] 음성 메모 기능
- [ ] 다국어 지원

---

## 📞 문의 및 지원

### 개발자 노트
이 시스템은 KUWOTECH 영업관리 시스템의 일부로 개발되었습니다.
- **데이터베이스**: MySQL (Railway 호스팅)
- **인증 방식**: JWT (JSON Web Token)
- **API 스타일**: RESTful

### 주의사항
1. **권한 관리**: 작성자와 관리자만 수정/삭제 가능
2. **Soft Delete**: 실제 삭제 대신 status를 '삭제됨'으로 변경
3. **알림 최적화**: 재직 중인 직원에게만 알림 생성
4. **매년 반복**: 생일, 기념일 등은 매년 자동으로 알림

---

**최종 업데이트**: 2025-10-17
**작성자**: Claude Code
**버전**: 1.0.0
